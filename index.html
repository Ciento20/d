<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=0.68, maximum-scale=1.0, user-scalable=no">
  <title>Smart TV Stream - Pro Player</title>
  <style>
    :root {
      /* Colores base din√°micos */
      --primary: #2563eb;
      --primary-rgb: 37, 99, 235;
      --primary-light: rgba(var(--primary-rgb), 0.2);
      --primary-dark: #1e50c7;
      
      --bg-dark: #0f0f0f;
      --card-bg: #1a1a1a;
      --sidebar-bg: #0a0a0a;
      --text: #f8fafc;
      --text-dim: #94a3b8;
      --border-color: #2e2e2e;
      --radius-md: 12px;
      --radius-sm: 8px;
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
    }
    
    body.dark-mode {
      --bg-dark: #0f0f0f;
      --card-bg: #1a1a1a;
      --text: #f8fafc;
    }

    body {
      background: var(--bg-dark);
      color: var(--text);
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      margin: 0;
      padding: 0;
      overflow-x: hidden;
      transition: background 0.3s;
    }

    /* LOADER DISCRETO (NO BLOQUEANTE) */
    #loader-container {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 4px; /* Barra delgada superior */
      background: var(--border-color);
      z-index: 9999;
      transition: opacity 0.5s ease;
    }

    .loader-bar {
      height: 100%;
      width: 30%;
      background: var(--primary);
      box-shadow: 0 0 10px var(--primary);
      animation: loading-slide 2s infinite ease-in-out;
    }

    @keyframes loading-slide {
      0% { transform: translateX(-100%); width: 10%; }
      50% { width: 40%; }
      100% { transform: translateX(1000%); width: 10%; }
    }

    .loader-text-overlay {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--card-bg);
      padding: 10px 20px;
      border-radius: 50px;
      border: 1px solid var(--primary);
      font-size: 0.8rem;
      z-index: 9999;
      box-shadow: var(--shadow-lg);
    }

    /* CONTENEDOR PRINCIPAL - SIEMPRE VISIBLE */
    .app-container {
      display: flex;
      flex-direction: row;
      min-height: 100vh;
      opacity: 1;
    }

    .loading-finished #loader-container,
    .loading-finished .loader-text-overlay {
      opacity: 0;
      visibility: hidden;
    }

    /* BARRA LATERAL */
    .sidebar {
      width: 80px;
      background: var(--sidebar-bg);
      border-right: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem 0;
      position: fixed;
      height: 100vh;
      z-index: 1000;
      transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .sidebar:hover { width: 200px; }

    .main-content {
      flex: 1;
      margin-left: 80px;
      padding: 0.5rem 2rem;
      width: calc(100% - 80px);
      display: flex;
      flex-direction: column;
    }

    /* FILTROS DIN√ÅMICOS */
    .dynamic-filters {
      display: flex;
      gap: 10px;
      overflow-x: auto;
      padding: 10px 0 5px 0;
      scrollbar-width: none;
    }
    .dynamic-filters::-webkit-scrollbar { display: none; }

    .filter-chip {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      color: var(--text);
      padding: 8px 16px;
      border-radius: 20px;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.2s;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .filter-chip:hover {
      border-color: var(--primary);
      background: var(--primary-light);
    }

    .filter-chip--active {
      background: var(--primary) !important;
      color: white;
      border-color: var(--primary);
    }

    /* REPRODUCTOR */
    .player-section {
      margin-bottom: 2rem;
      border-radius: var(--radius-md);
      overflow: hidden;
      background: #000;
    }

    .player-container {
      aspect-ratio: 16 / 9;
      width: 100%;
      display: none;
    }

    .player-container--active { display: block; }
    #videoFrame { width: 100%; height: 100%; border: none; }

    .player-controls {
      background: var(--card-bg);
      padding: 1rem;
      display: none;
      align-items: center;
      justify-content: center;
      gap: 15px;
      position: relative;
    }

    .player-controls--active { display: flex; }

    /* BOTONES NAVEGACI√ìN */
    .nav-group {
      display: flex;
      flex-direction: column;
      gap: 0.8rem;
      width: 100%;
      padding: 0 10px;
    }

    .filter-button {
      background: transparent;
      border: none;
      color: var(--text-dim);
      padding: 0.8rem;
      border-radius: var(--radius-sm);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 15px;
      transition: all 0.2s;
      width: 100%;
      overflow: hidden;
      white-space: nowrap;
    }

    .sidebar span { opacity: 0; transition: opacity 0.2s; pointer-events: none; }
    .sidebar:hover span { opacity: 1; pointer-events: auto; }

    .filter-button:hover { background: var(--primary-light); color: var(--text); }
    .filter-button--active { background: var(--primary) !important; color: white !important; border-radius: 50px; margin: 8px; height: calc(100% - 16px) !important; padding: 0 20px !important; box-shadow: 0 4px 10px var(--primary-light); }

    /* BUSCADOR */
    .search-container {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 1rem;
      max-width: 560px;
    }

    .search-box {
      flex: 1;
    }

    .search-box input {
      width: 100%;
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      padding: 0.8rem 1.5rem;
      border-radius: 50px;
      color: white;
      outline: none;
      box-sizing: border-box;
    }

    .clear-filters-btn {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      border: 1px solid var(--border-color);
      background: var(--card-bg);
      color: var(--text);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      transition: all 0.3s ease;
      flex-shrink: 0;
    }

    .clear-filters-btn:hover {
      background: #ef4444;
      border-color: #ef4444;
    }

    /* CARRUSELES */
    .channel-group { margin-bottom: 1.2rem; }
    #fechaContainer { margin: 0; }
    #fecha { margin-top: 5px; margin-bottom: 10px; }
    .channel-group__header { margin-bottom: 0.5rem; padding-left: 0.5rem; }    .channel-group__title { font-size: 1.2rem; font-weight: bold; display: flex; align-items: center; gap: 10px; }

    .tv-group-title {
      font-size: 0.95rem;
      font-weight: 700;
      color: #e0e0e0;
      border-left: 2px solid var(--primary); 
      padding-left: 7.5px;
      width: 100%;
      margin-top: 0;
    }
    .channel-group__sport { color: var(--primary); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px; }

    .channel-group__content {
      display: flex;
      overflow-x: auto;
      gap: 1.2rem;
      padding: 1rem 0.5rem;
      scrollbar-width: none;
    }

    /* Vista de cuadr√≠cula para el cat√°logo */
    .catalog-grid {
      display: grid !important;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 1.5rem;
      overflow-x: visible !important;
      padding: 1rem 0.5rem;
    }
    .channel-group__content::-webkit-scrollbar { display: none; }

    .channel-card {
      min-width: 220px;
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      padding: 1.2rem;
      cursor: pointer;
      transition: transform 0.3s ease;
      flex-shrink: 0;
    }

    .channel-card:hover {
      transform: scale(1.05);
      border-color: var(--primary);
      box-shadow: 0 0 15px var(--primary-light);
    }

    .channel-name { font-weight: 700; text-align: center; margin: 8px 0; font-size: 0.95rem; }
    .channel-number { font-size: 0.7rem; color: var(--primary); font-weight: bold; text-align: center; }
    .channel-time { font-size: 0.95rem; color: var(--text-dim); text-align: center; }
    .channel-time--live::before {
      content: ""; display: inline-block; width: 8px; height: 8px;
      background: #ff0000; border-radius: 50%; margin-right: 6px;
      animation: pulse 1.5s infinite;
    }

    /* NO RESULTS */
    .no-results-container {
      display: flex;
      justify-content: center;
      align-items: center;
      flex-grow: 1;
      width: 100%;
      min-height: 300px;
    }

    .no-results {
      text-align: center;
      padding: 2rem;
      background: var(--card-bg);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-lg);
      max-width: 400px;
      width: 90%;
      border: 1px solid var(--border-color);
    }

    .no-results-icon { font-size: 2.5rem; margin-bottom: 1rem; opacity: 0.5; }
    .no-results-text { font-size: 1.1rem; color: var(--text); margin-bottom: 0.5rem; font-weight: 600; }
    .no-results-hint { font-size: 0.9rem; color: var(--text-dim); line-height: 1.4; }

    /* MODALES */
    .modal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.85);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }
    .modal--active { display: flex; }
    .modal__content {
      background: #1a1a1a;
      padding: 2rem;
      border-radius: var(--radius-md);
      width: 90%;
      max-width: 400px;
      border: 1px solid #333;
    }

    .settings-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.2rem;
    }

    /* COLOR PICKER */
    .color-picker { display: flex; gap: 10px; margin-top: 5px; }
    .color-option {
        width: 32px; height: 32px;
        border-radius: 50%;
        border: 2px solid #555;
        cursor: pointer;
        transition: transform 0.2s, border-color 0.2s;
    }
    .color-option:hover { transform: scale(1.15); }
    .color-option.active { border-color: white; outline: 2px solid var(--primary); }

    /* SWITCHES */
    .settings-switch { position: relative; width: 44px; height: 22px; }
    .settings-switch input { opacity: 0; width: 0; height: 0; }
    .settings-slider {
      position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
      background-color: #333; transition: .4s; border-radius: 34px;
    }
    .settings-slider:before {
      position: absolute; content: ""; height: 16px; width: 16px;
      left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%;
    }
    input:checked + .settings-slider { background-color: var(--primary); }
    input:checked + .settings-slider:before { transform: translateX(22px); }

    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }

    @media (max-width: 768px) {
      .sidebar {
        width: 100%; height: 65px; bottom: 0; top: auto;
        flex-direction: row; border-right: none; border-top: 1px solid var(--border-color);
        padding: 0;
      }
      .sidebar:hover { width: 100%; }
      .nav-group { flex-direction: row; justify-content: space-around; padding: 0 10px; height: 100%; gap: 5px; align-items: center; }
      .filter-button { justify-content: center; padding: 0; height: 100%; font-size: 1.4rem; gap: 0; display: flex; align-items: center; border-radius: 50px; transition: all 0.3s ease; }
      .main-content { margin-left: 0; margin-bottom: 80px; padding: 1rem; }
      .sidebar span { display: none !important; }
      .search-container { max-width: 100%; }
    }
  </style>
</head>
<body>

  <div id="loader-container">
    <div class="loader-bar"></div>
  </div>

  <div class="loader-text-overlay" id="loader-status">
    üì° Sincronizando canales...
  </div>

  <div class="app-container">
    <nav class="sidebar">
      <div class="nav-group">
        <button class="filter-button" id="filterFavorites" style="display: none !important;">‚≠ê <span>Favoritos</span></button>
        <button class="filter-button filter-button--active" id="filterAll">üè† <span>Inicio</span></button>
        <button class="filter-button" id="filterCatalog">üìö <span>Cat√°logo</span></button>
        <button class="filter-button" id="filterLive" style="display: none !important;">üî¥ <span>Directo</span></button>
        <button class="filter-button" id="openSettingsBtn">‚öôÔ∏è <span>Ajustes</span></button>
      </div>
    </nav>

    <main class="main-content">
      <div class="search-container">
        <div class="search-box">
          <input type="text" id="searchInput" placeholder="Busca un canal o evento...">
        </div>
        <button class="clear-filters-btn" id="clearFiltersBtn" title="Limpiar todos los filtros">x</button>
      </div>

      <div class="dynamic-filters" id="dynamicFilters"></div>

      <div class="player-section">
        <div class="player-container" id="playerContainer">
          <iframe id="videoFrame" allowfullscreen></iframe>
        </div>
        <div class="player-controls" id="playerControls">
          <span id="channelInfo" style="color: var(--primary); font-weight: bold;"></span>
          <button class="filter-button" id="prevChannelBtn" style="width: auto;">‚óÑ</button>
          <button class="filter-button" id="nextChannelBtn" style="width: auto;">‚ñ∫</button>
          <button class="filter-button" id="favoriteBtn" style="width: auto;">‚òÖ</button>
          <button class="filter-button" id="closePlayerBtn" style="width: auto;">√ó</button>
        </div>
      </div>

      <div id="fechaContainer">
        <h2 id="fecha">Actualizando programaci√≥n...</h2>
      </div>

      <div id="results"></div>
    </main>
  </div>

  <div class="modal" id="settingsModal">
    <div class="modal__content">
      <h2 style="margin-top: 0;">‚öôÔ∏è Ajustes</h2>
      
      <div style="margin-bottom: 1.5rem;">
        <span style="display: block; margin-bottom: 8px;">Color del Tema</span>
        <div class="color-picker">
            <button class="color-option" data-color="#2563eb" style="background:#2563eb"></button>
            <button class="color-option" data-color="#dc2626" style="background:#dc2626"></button>
            <button class="color-option" data-color="#16a34a" style="background:#16a34a"></button>
            <button class="color-option" data-color="#79006f" style="background:#79006f"></button>
            <button class="color-option" data-color="#ea580c" style="background:#ea580c"></button>
        </div>
      </div>

      <div class="settings-item">
        <span>Modo Oscuro</span>
        <label class="settings-switch">
          <input type="checkbox" id="darkModeToggle">
          <span class="settings-slider"></span>
        </label>
      </div>

      <div class="settings-item">
        <span>Filtrar Internacional</span>
        <label class="settings-switch">
          <input type="checkbox" id="internationalFilterToggle">
          <span class="settings-slider"></span>
        </label>
      </div>

      <div style="margin-bottom: 1.5rem;">
        <span style="display: block; margin-bottom: 8px;">Fuente de Reproductor</span>
        <select id="baseDomainSelect" style="width: 100%; padding: 10px; background: #333; color: white; border: 1px solid #444; border-radius: 8px;">
          <option value="yeahstreams.com/plus/">YeahStreams</option>
          <option value="daddyhd.com/casting/">DaddyHD</option>
          <option value="abbasport.online/footy.php?id=">AbbaSport</option>
          <option value="footballschedule.online/albaplayer/">AlbaPlayer</option>
          <option value="daddylives.top/watch.php?id=">DaddyLives</option>
        </select>
      </div>

      <button class="filter-button" id="syncAutoNamesBtn" style="background: #333; margin-bottom: 10px; justify-content: center;">üîÑ Sincronizar nombres 24/7</button>
      <button class="filter-button" id="closeSettingsBtn" style="background: var(--primary); color: white; justify-content: center;">Guardar y Cerrar</button>
    </div>
  </div>

  <script>
    const state = {
      channels: JSON.parse(localStorage.getItem('channelsCache')) || [],
      lastHtmlHash: localStorage.getItem('lastHtmlHash') || null,
      autoNamesMap: JSON.parse(localStorage.getItem('autoNamesMap')) || {},
      currentChannel: null,
      currentFilter: localStorage.getItem('lastFilter') || 'all',
      sportFilters: JSON.parse(localStorage.getItem('lastSportFilters')) || [],
      activeFilters: JSON.parse(localStorage.getItem('activeFilters')) || { favorites: false, live: false },
      searchTerm: '',
      favorites: JSON.parse(localStorage.getItem('favorites')) || [],
      customNames: JSON.parse(localStorage.getItem('customNames')) || {},
      baseDomain: localStorage.getItem('baseDomain') || 'daddylives.top/watch.php?id=',
      internationalFilter: localStorage.getItem('internationalFilter') === 'true',
      darkMode: localStorage.getItem('darkMode') !== 'false',
      primaryColor: localStorage.getItem('miWeb_color') || '#2563eb',
      filteredKeywords: [
        "Cricket", "Russia", "Golf", "PL", "NZ", "BR", "Morocco", "Malaysia", "Arabic", "Astro", "Willow", "SuperSport", "Star Sports", "Sony Ten",
        "France", "Turkiye", "Turkey", "Portugal", "Serbia", "MENA", "DE", "Croatia", "Brasil", "Israel", "Italy", "Poland", "NL"
      ],
      searchTimeout: null,
      sportEmojis: {
        "TV SHOWS": "üì∫", "SOCCER": "‚öΩ", "CRICKET": "üèè", "TENNIS": "üéæ", "MOTORSPORT": "üèÅ",
        "BADMINTON": "üè∏", "MMA": "üëä", "AM. FOOTBALL": "üèà", "NBA": "‚õπÔ∏è", "VOLLEYBALL": "üèê",
        "BASKETBALL": "üèÄ", "WWE": "ü§º‚Äç‚ôÇÔ∏è", "GOLF": "‚õ≥", "HORSE RACING": "üèá", "ICE HOCKEY": "üèí",
        "NHL": "üèí", "SNOOKER": "üé±", "WATER POLO": "ü§Ω"
      },
      proxies: [
        "https://api.allorigins.win/raw?url=",
        "https://api.codetabs.com/v1/proxy/?quest=",
        "https://corsproxy.io/?",
        "https://thingproxy.freeboard.io/fetch/"
      ]
    };

    function hexToRgb(hex) {
        const r = parseInt(hex.slice(1, 3), 16);
        const g = parseInt(hex.slice(3, 5), 16);
        const b = parseInt(hex.slice(5, 7), 16);
        return { r, g, b };
    }

    function changeThemeColor(color) {
        const rgb = hexToRgb(color);
        document.documentElement.style.setProperty('--primary', color);
        document.documentElement.style.setProperty('--primary-rgb', `${rgb.r}, ${rgb.g}, ${rgb.b}`);
        localStorage.setItem('miWeb_color', color);
        state.primaryColor = color;
        
        document.querySelectorAll('.color-option').forEach(btn => {
            btn.classList.toggle('active', btn.getAttribute('data-color') === color);
        });
    }

    function setAppReady() {
      document.body.classList.add('loading-finished');
    }

    function hashCode(str) {
      let hash = 0;
      for (let i = 0; i < str.length; i++) {
        const char = str.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash |= 0;
      }
      return hash.toString();
    }

    async function fetchWithFallback(targetUrl) {
      for (const proxy of state.proxies) {
        try {
          const response = await fetch(proxy + encodeURIComponent(targetUrl));
          if (!response.ok) throw new Error('Proxy fall√≥');
          const data = await response.text();
          if (data && data.length > 100) return data;
        } catch (e) {
          console.warn(`Error con el proxy ${proxy}, intentando el siguiente...`);
        }
      }
      throw new Error('Todos los proxies fallaron');
    }

    async function syncAutoNames() {
      try {
        const html = await fetchWithFallback("https://daddylives.top/24-7-channels/");
        const doc = new DOMParser().parseFromString(html, "text/html");
        const map = {};
        doc.querySelectorAll(".gi").forEach(el => {
          const name = el.querySelector(".text")?.textContent.trim();
          const num = el.querySelector(".num")?.textContent.trim();
          if (num && name) map[num] = name;
        });
        state.autoNamesMap = map;
        localStorage.setItem('autoNamesMap', JSON.stringify(map));
        renderResults();
      } catch (e) { console.error("Error sincronizando nombres:", e); }
    }

    function getDisplayName(channel) {
      if (!channel) return "Desconocido";
      return state.customNames[channel.number] || state.autoNamesMap[channel.number] || channel.name || `Canal ${channel.number}`;
    }

    function getSportWithEmoji(sportName) {
      if (!sportName) return "üì∫ TV";
      const upperSport = sportName.toUpperCase();
      for (const [key, emoji] of Object.entries(state.sportEmojis)) {
        if (upperSport.includes(key)) return `${emoji} ${sportName}`;
      }
      return sportName;
    }

    function getEmojiOnly(sportName) {
      if (!sportName) return "üì∫";
      const upperSport = sportName.toUpperCase();
      for (const [key, emoji] of Object.entries(state.sportEmojis)) {
        if (upperSport.includes(key)) return emoji;
      }
      return "üèÜ";
    }

    function adjustTime(time) {
      if (!time || time === 'LIVE') return time;
      const [h, m] = time.split(':').map(Number);
      return `${String((h + 1) % 24).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
    }

    function isChannelLive(channel) {
      if (channel.time === 'LIVE') return true;
      if (!channel.time) return false;
      const now = new Date();
      const current = now.getHours() * 60 + now.getMinutes();
      const adjusted = adjustTime(channel.time);
      const [h, m] = adjusted.split(':').map(Number);
      const start = h * 60 + m;
      return current >= start - 15 && current <= start + 120;
    }

    function playChannel(channel) {
      state.currentChannel = channel;
      document.getElementById('playerContainer').classList.add('player-container--active');
      document.getElementById('playerControls').classList.add('player-controls--active');
      document.getElementById('channelInfo').textContent = getDisplayName(channel);
      
      const favBtn = document.getElementById('favoriteBtn');
      favBtn.textContent = state.favorites.includes(channel.number) ? '‚òÖ' : '‚òÜ';
      favBtn.style.color = state.favorites.includes(channel.number) ? '#fbbf24' : 'var(--text-dim)';

      const frame = document.getElementById('videoFrame');
      const streamUrl = state.baseDomain.includes('php?id=') ? 
        `https://${state.baseDomain}${channel.number}` : 
        `https://${state.baseDomain}stream-${channel.number}.php`;
      
      frame.src = streamUrl;
      window.scrollTo({top: 0, behavior: 'smooth'});
    }

    function navigateEventChannel(direction) {
      if (!state.currentChannel) return;
      const eventChannels = state.channels.filter(c => 
        state.currentChannel.event && c.event === state.currentChannel.event
      );

      if (eventChannels.length > 1) {
        const currentIndex = eventChannels.findIndex(c => c.number === state.currentChannel.number);
        let nextIndex = direction === 'next' ? 
          (currentIndex + 1) % eventChannels.length : 
          (currentIndex - 1 + eventChannels.length) % eventChannels.length;
        playChannel(eventChannels[nextIndex]);
      } else {
        const currentNum = parseInt(state.currentChannel.number);
        if (isNaN(currentNum)) return;
        const nextNum = direction === 'next' ? currentNum + 1 : currentNum - 1;
        if (nextNum < 1) return;
        let nextChannel = state.channels.find(c => parseInt(c.number) === nextNum);
        if (!nextChannel) {
          nextChannel = {
            number: nextNum.toString(),
            name: state.autoNamesMap[nextNum.toString()] || `Canal ${nextNum}`,
            event: 'Canal directo', sport: 'TV', time: ''
          };
        }
        playChannel(nextChannel);
      }
    }    function updateDynamicFilters() {
      const filterContainer = document.getElementById('dynamicFilters');
      if (!state.channels.length) return;
      const sports = [...new Set(state.channels.map(c => c.sport).filter(Boolean))].sort();      const favChip = `
        <button class="filter-chip ${state.activeFilters.favorites ? 'filter-chip--active' : ''}" 
                onclick="toggleMainFilter('favorites')">
          <span>‚≠ê</span> Favoritos
        </button>`;

      const liveChip = `
        <button class="filter-chip ${state.activeFilters.live ? 'filter-chip--active' : ''}" 
                onclick="toggleMainFilter('live')">
          <span>üî¥</span> Directo
        </button>`;

      filterContainer.innerHTML = favChip + liveChip + sports.map(sport => {
        const emoji = getEmojiOnly(sport);
        const isActive = state.sportFilters.includes(sport);
        return `
          <button class="filter-chip ${isActive ? 'filter-chip--active' : ''}" 
                  onclick="toggleSportFilter('${sport}')">
            <span>${emoji}</span> ${sport}
          </button>
        `;
      }).join('');
    }

    function toggleSportFilter(sport) {
      const index = state.sportFilters.indexOf(sport);
      if (index > -1) {
        state.sportFilters.splice(index, 1);
      } else {
        state.sportFilters.push(sport);
        state.currentFilter = 'all';
        document.querySelectorAll('.filter-button').forEach(b => b.classList.remove('filter-button--active'));
        document.getElementById('filterAll').classList.add('filter-button--active');
      }
      localStorage.setItem('lastSportFilters', JSON.stringify(state.sportFilters));
      renderResults();
    }

    function toggleMainFilter(type) {
      state.activeFilters[type] = !state.activeFilters[type];
      localStorage.setItem('activeFilters', JSON.stringify(state.activeFilters));
      renderResults();
    }

    function renderResults() {
      const resultsDiv = document.getElementById('results');
      updateDynamicFilters();
      
      let sourceList = state.channels;

      // MODO CAT√ÅLOGO: Crear lista basada en todos los n√∫meros conocidos
      if (state.currentFilter === 'catalog') {
        const allKnownNumbers = new Set([
            ...state.channels.map(c => c.number),
            ...Object.keys(state.autoNamesMap)
        ]);
        sourceList = Array.from(allKnownNumbers).map(num => {
            const cached = state.channels.find(c => c.number === num);
            return cached || { 
                number: num, 
                name: state.autoNamesMap[num] || `Canal ${num}`, 
                event: 'Disponible en Cat√°logo', 
                sport: 'TV 24/7', 
                time: '' 
            };
        }).sort((a, b) => parseInt(a.number) - parseInt(b.number));
      }

      const filtered = sourceList.filter(c => {
        const displayName = getDisplayName(c).toLowerCase();
        const eventName = (c.event || "").toLowerCase();
        
        if (state.sportFilters.length > 0 && !state.sportFilters.includes(c.sport)) return false;
        if (state.activeFilters.favorites && !state.favorites.includes(c.number)) return false;
        if (state.activeFilters.live && !isChannelLive(c)) return false;
        
        if (state.searchTerm && 
            !displayName.includes(state.searchTerm.toLowerCase()) && 
            !eventName.includes(state.searchTerm.toLowerCase()) && 
            c.number !== state.searchTerm) return false;
            
        if (state.internationalFilter) {
          const isInternational = state.filteredKeywords.some(keyword => 
            displayName.includes(keyword.toLowerCase()) || 
            (c.name && c.name.toLowerCase().includes(keyword.toLowerCase()))
          );
          if (isInternational) return false;
        }
        return true;
      });

      if (filtered.length === 0) {
        resultsDiv.innerHTML = `
          <div class="no-results-container">
            <div class="no-results">
              <div class="no-results-icon">üì°</div>
              <div class="no-results-text">No se encontraron canales</div>
              <div class="no-results-hint">Prueba con otros filtros o t√©rminos de b√∫squeda.</div>
            </div>
          </div>
        `;
        return;
      }

      const groups = {};
      filtered.forEach(c => {
        const key = state.currentFilter === 'catalog' ? `Cat√°logo Completo| |Offline` : `${c.event}|${c.time}|${c.sport}`;
        if (!groups[key]) groups[key] = [];
        groups[key].push(c);
      });
      
      resultsDiv.innerHTML = Object.entries(groups).map(([key, channels]) => {
        const [event, time, sport] = key.split('|');
        const isCatalog = state.currentFilter === 'catalog';
        return `
          <div class="channel-group">
            <div class="channel-group__header">
              <div class="channel-group__sport">${getSportWithEmoji(sport)}</div>
              <div class="channel-group__title">
                ${time.trim() ? `<span class="channel-time ${time === 'LIVE' ? 'channel-time--live' : ''}">${adjustTime(time)}</span>` : ''}
                <div class="tv-group-title">${event}</div>
              </div>
            </div>
            <div class="channel-group__content ${isCatalog ? 'catalog-grid' : ''}">
              ${channels.map(c => `
                <div class="channel-card" style="${isCatalog ? 'min-width: unset;' : ''}" onclick='playChannel(${JSON.stringify(c)})'>
                  <div class="channel-number">CH ${c.number}</div>
                  <div class="channel-name">${getDisplayName(c)}</div>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      }).join('');
    }

    function translateDate(text) {
      const dayMap = { 'Monday': 'Lunes', 'Tuesday': 'Martes', 'Wednesday': 'Mi√©rcoles', 'Thursday': 'Jueves', 'Friday': 'Viernes', 'Saturday': 'S√°bado', 'Sunday': 'Domingo' };
      const monthMap = { 'January': 'Enero', 'February': 'Febrero', 'March': 'Marzo', 'April': 'Abril', 'May': 'Mayo', 'June': 'Junio', 'July': 'Julio', 'August': 'Agosto', 'September': 'Septiembre', 'October': 'Octubre', 'November': 'Noviembre', 'December': 'Diciembre' };
      let translated = text;
      Object.keys(dayMap).forEach(en => translated = translated.replace(new RegExp(en, 'g'), dayMap[en]));
      Object.keys(monthMap).forEach(en => translated = translated.replace(new RegExp(en, 'g'), monthMap[en]));
      return translated.replace('Schedule for', 'Programaci√≥n para');
    }

    async function scrape() {
      try {
        const html = await fetchWithFallback("https://daddylives.top/match-schedule/");
        const currentHash = hashCode(html);
        const doc = new DOMParser().parseFromString(html, "text/html");
        
        const fechaElemento = doc.querySelector(".daddy-schedule-title");
        if (fechaElemento) {
          const rawDate = fechaElemento.textContent.split('‚Äì')[0].trim();
          document.getElementById('fecha').textContent = translateDate(rawDate);
        }

        if (state.lastHtmlHash !== currentHash || state.channels.length === 0) {
          const found = [];
          doc.querySelectorAll(".match-category").forEach(cat => {
            let sport = cat.querySelector(".category-title")?.textContent.trim().replace(/\s*\(\d+\)/g, '');
            cat.querySelectorAll(".match-section").forEach(sec => {
              const time = sec.querySelector(".time")?.textContent.trim();
              const event = sec.querySelector(".match-name")?.textContent.trim();
              sec.querySelectorAll(".link-button").forEach(link => {
                const linkText = link.textContent.trim();
                if (linkText.toUpperCase() === "CH-4K" || linkText.toUpperCase() === "CH-HD") return; 
                const match = linkText.match(/CH-(\d+)/i);
                if (match) {
                  found.push({ number: match[1], name: linkText, time, event, sport });
                }
              });
            });
          });
          if (found.length > 0) {
            state.channels = found;
            state.lastHtmlHash = currentHash;
            localStorage.setItem('channelsCache', JSON.stringify(found));
            localStorage.setItem('lastHtmlHash', currentHash);
          }
        }
        renderResults();
      } catch (e) { 
        document.getElementById('fecha').textContent = "Error al conectar con la fuente"; 
      } finally {
        setAppReady();
      }
    }

    document.getElementById('searchInput').oninput = (e) => {
      state.searchTerm = e.target.value.trim();
      renderResults();
      clearTimeout(state.searchTimeout);
      if (/^\d+$/.test(state.searchTerm)) {
        state.searchTimeout = setTimeout(() => {
          let target = state.channels.find(c => c.number === state.searchTerm);
          if (!target) target = { number: state.searchTerm, name: state.autoNamesMap[state.searchTerm] || `Canal ${state.searchTerm}`, event: 'Canal directo', sport: 'TV', time: '' };
          playChannel(target);
        }, 800);
      }
    };

    document.querySelectorAll('.color-option').forEach(btn => {
        btn.addEventListener('click', () => {
            changeThemeColor(btn.getAttribute('data-color'));
        });
    });

    document.getElementById('syncAutoNamesBtn').onclick = syncAutoNames;
    document.getElementById('nextChannelBtn').onclick = () => navigateEventChannel('next');
    document.getElementById('prevChannelBtn').onclick = () => navigateEventChannel('prev');
    document.getElementById('favoriteBtn').onclick = () => {
      const num = state.currentChannel?.number;
      if (!num) return;
      const idx = state.favorites.indexOf(num);
      idx === -1 ? state.favorites.push(num) : state.favorites.splice(idx, 1);
      localStorage.setItem('favorites', JSON.stringify(state.favorites));
      playChannel(state.currentChannel);
      renderResults();
    };
    document.getElementById('clearFiltersBtn').onclick = () => {
      state.searchTerm = ''; state.sportFilters = []; state.activeFilters = { favorites: false, live: false };
      document.getElementById('searchInput').value = '';
      document.getElementById('filterAll').click();
    };
    document.getElementById('openSettingsBtn').onclick = () => document.getElementById('settingsModal').classList.add('modal--active');
    document.getElementById('closeSettingsBtn').onclick = () => document.getElementById('settingsModal').classList.remove('modal--active');
    
    document.getElementById('darkModeToggle').checked = state.darkMode;
    document.getElementById('darkModeToggle').onchange = (e) => {
      state.darkMode = e.target.checked;
      localStorage.setItem('darkMode', state.darkMode);
      document.body.classList.toggle('dark-mode', state.darkMode);
    };

    document.getElementById('internationalFilterToggle').checked = state.internationalFilter;
    document.getElementById('internationalFilterToggle').onchange = (e) => {
      state.internationalFilter = e.target.checked;
      localStorage.setItem('internationalFilter', state.internationalFilter);
      renderResults();
    };

    document.getElementById('baseDomainSelect').value = state.baseDomain;
    document.getElementById('baseDomainSelect').onchange = (e) => {
      state.baseDomain = e.target.value;
      localStorage.setItem('baseDomain', state.baseDomain);
    };

    document.getElementById('closePlayerBtn').onclick = () => {
      document.getElementById('playerContainer').classList.remove('player-container--active');
      document.getElementById('playerControls').classList.remove('player-controls--active');
      document.getElementById('videoFrame').src = '';
      state.currentChannel = null;
    };

    const navButtons = document.querySelectorAll('.nav-group .filter-button');
    function setActiveNav(btnId) {
        navButtons.forEach(b => b.classList.remove('filter-button--active'));
        const target = document.getElementById(btnId);
        if (target) target.classList.add('filter-button--active');
    }

    function updateNavState(filter) {
      const map = { 'all': 'filterAll', 'catalog': 'filterCatalog' };
      if (map[filter]) {
        setActiveNav(map[filter]);
        state.currentFilter = filter;
        if (filter === 'catalog') {
          state.activeFilters = { favorites: false, live: false };
          state.sportFilters = [];
        }
        renderResults();
      }
    }

    document.getElementById('filterAll').onclick = () => { state.currentFilter = 'all'; state.sportFilter = null; localStorage.removeItem('lastSportFilter'); updateNavState('all'); renderResults(); };
    document.getElementById('filterLive').onclick = () => toggleMainFilter('live');
    document.getElementById('filterFavorites').onclick = () => toggleMainFilter('favorites');
    document.getElementById('filterCatalog').onclick = () => { state.currentFilter = 'catalog'; updateNavState('catalog'); renderResults(); };

    // INICIALIZACI√ìN
    if(state.darkMode) document.body.classList.add('dark-mode');
    changeThemeColor(state.primaryColor);
    updateNavState(state.currentFilter);
    renderResults(); if (Object.keys(state.autoNamesMap).length === 0) syncAutoNames();
    scrape();
  </script>
</body>
</html>

