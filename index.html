<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=0.68, maximum-scale=1.0, user-scalable=no">
  <title>Smart TV Stream</title>
  <style>
    :root {
      --primary: #2563eb;
      --primary-light: rgba(37, 99, 235, 0.2);
      --primary-dark: #1e50c7;
      --bg-dark: #0f0f0f;
      --card-bg: #1a1a1a;
      --sidebar-bg: #0a0a0a;
      --text: #f8fafc;
      --text-dim: #94a3b8;
      --border-color: #2e2e2e;
      --radius-md: 12px;
      --radius-sm: 8px;
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
    }
    
    body.dark-mode {
      --bg-dark: #0f0f0f;
      --card-bg: #1a1a1a;
      --text: #f8fafc;
    }

    body {
      background: var(--bg-dark);
      color: var(--text);
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      margin: 0;
      padding: 0;
      overflow-x: hidden;
      transition: background 0.3s;
    }

    .app-container {
      display: flex;
      flex-direction: row;
      min-height: 100vh;
    }

    /* BARRA LATERAL */
    .sidebar {
      width: 80px;
      background: var(--sidebar-bg);
      border-right: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem 0;
      position: fixed;
      height: 100vh;
      z-index: 1000;
      transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .sidebar:hover { width: 200px; }

    .main-content {
      flex: 1;
      margin-left: 80px;
      padding: 1rem 2rem;
      width: calc(100% - 80px);
    }

    /* REPRODUCTOR */
    .player-section {
      margin-bottom: 2rem;
      border-radius: var(--radius-md);
      overflow: hidden;
      background: #000;
    }

    .player-container {
      aspect-ratio: 16 / 9;
      width: 100%;
      display: none;
    }

    .player-container--active { display: block; }
    #videoFrame { width: 100%; height: 100%; border: none; }

    .player-controls {
      background: var(--card-bg);
      padding: 1rem;
      display: none;
      align-items: center;
      justify-content: center;
      gap: 15px;
      position: relative;
    }

    .player-controls--active { display: flex; }

    /* BOTONES NAVEGACI√ìN */
    .nav-group {
      display: flex;
      flex-direction: column;
      gap: 0.8rem;
      width: 100%;
      padding: 0 10px;
    }

    .filter-button, .emoji-filter-btn {
      background: transparent;
      border: none;
      color: var(--text-dim);
      padding: 0.8rem;
      border-radius: var(--radius-sm);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 15px;
      transition: all 0.2s;
      width: 100%;
      overflow: hidden;
      white-space: nowrap;
    }

    .sidebar span { opacity: 0; transition: opacity 0.2s; pointer-events: none; }
    .sidebar:hover span { opacity: 1; pointer-events: auto; }

    .filter-button:hover, .emoji-filter-btn:hover { background: var(--primary-light); color: var(--text); }
    .filter-button--active, .emoji-filter-btn--active { background: var(--primary) !important; color: white !important; }

    /* BUSCADOR */
    .search-box { margin-bottom: 2rem; }
    .search-box input {
      width: 100%;
      max-width: 500px;
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      padding: 0.8rem 1.5rem;
      border-radius: 50px;
      color: white;
      outline: none;
    }

    /* CARRUSELES */
    .channel-group { margin-bottom: 2.5rem; }
    .channel-group__header { margin-bottom: 1rem; padding-left: 0.5rem; }
    .channel-group__title { font-size: 1.2rem; font-weight: bold; display: flex; align-items: center; gap: 10px; }
    .channel-group__sport { color: var(--primary); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; }

    .channel-group__content {
      display: flex;
      overflow-x: auto;
      gap: 1.2rem;
      padding: 1rem 0.5rem;
      scrollbar-width: none;
    }
    .channel-group__content::-webkit-scrollbar { display: none; }

    .channel-card {
      min-width: 220px;
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      padding: 1.2rem;
      cursor: pointer;
      transition: transform 0.3s ease;
      flex-shrink: 0;
    }

    .channel-card:hover {
      transform: scale(1.05);
      border-color: var(--primary);
      box-shadow: 0 0 15px var(--primary-light);
    }

    .channel-name { font-weight: 700; text-align: center; margin: 8px 0; font-size: 0.95rem; }
    .channel-number { font-size: 0.7rem; color: var(--primary); font-weight: bold; text-align: center; }
    .channel-time { font-size: 0.8rem; color: var(--text-dim); text-align: center; }
    .channel-time--live::before {
      content: ""; display: inline-block; width: 8px; height: 8px;
      background: #ff0000; border-radius: 50%; margin-right: 6px;
      animation: pulse 1.5s infinite;
    }

    /* MODALES AJUSTES */
    .modal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.85);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }
    .modal--active { display: flex; }
    .modal__content {
      background: #1a1a1a;
      padding: 2rem;
      border-radius: var(--radius-md);
      width: 90%;
      max-width: 400px;
      border: 1px solid #333;
    }

    .settings-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.2rem;
    }

    /* SWITCHES */
    .settings-switch { position: relative; width: 44px; height: 22px; }
    .settings-switch input { opacity: 0; width: 0; height: 0; }
    .settings-slider {
      position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
      background-color: #333; transition: .4s; border-radius: 34px;
    }
    .settings-slider:before {
      position: absolute; content: ""; height: 16px; width: 16px;
      left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%;
    }
    input:checked + .settings-slider { background-color: var(--primary); }
    input:checked + .settings-slider:before { transform: translateX(22px); }

    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }

    @media (max-width: 768px) {
      .sidebar {
        width: 100%; height: 65px; bottom: 0; top: auto;
        flex-direction: row; border-right: none; border-top: 1px solid var(--border-color);
        padding: 0;
      }
      .sidebar:hover { width: 100%; }
      .nav-group { flex-direction: row; justify-content: space-around; padding: 0; }
      .main-content { margin-left: 0; margin-bottom: 80px; padding: 1rem; }
      .sidebar span { display: none; }
      #emojiFilters { display: none; }
    }
  </style>
</head>
<body>

  <div class="app-container">
    <nav class="sidebar">
      <div class="nav-group">
        <button class="filter-button" id="filterFavorites">‚≠ê <span>Favoritos</span></button>
        <button class="filter-button filter-button--active" id="filterAll">üè† <span>Inicio</span></button>
        <button class="filter-button" id="filterLive">üî¥ <span>Directo</span></button>
        <button class="filter-button" id="filterHistory">üïí <span>Historial</span></button>
        <button class="filter-button" id="clearEmojiFilters">‚öôÔ∏è <span>Ajustes</span></button>
      </div>
      
      <div class="nav-group" id="emojiFilters" style="margin-top: 2rem;">
        <button class="emoji-filter-btn" data-filter="F√∫tbol">‚öΩ <span>F√∫tbol</span></button>
        <button class="emoji-filter-btn" data-filter="Baloncesto">üèÄ <span>Basket</span></button>
        <button class="emoji-filter-btn" data-filter="Motorsport">üèÅ <span>Motor</span></button>
        <button class="emoji-filter-btn" data-filter="Spain ES Movistar M+">üá™üá∏ <span>M+ Espa√±a</span></button>
      </div>
    </nav>

    <main class="main-content">
      <div class="search-box">
        <input type="text" id="searchInput" placeholder="Buscar canal, evento o #n√∫mero...">
      </div>

      <div class="player-section">
        <div class="player-container" id="playerContainer">
          <iframe id="videoFrame" allowfullscreen></iframe>
        </div>
        <div class="player-controls" id="playerControls">
          <span id="channelInfo" style="color: var(--primary); font-weight: bold;"></span>
          <button class="filter-button" id="prevChannelBtn" style="width: auto;">‚óÑ</button>
          <button class="filter-button" id="nextChannelBtn" style="width: auto;">‚ñ∫</button>
          <button class="filter-button" id="favoriteBtn" style="width: auto;">‚òÖ</button>
          <button class="filter-button" id="closePlayerBtn" style="width: auto;">√ó</button>
        </div>
      </div>

      <div id="fechaContainer">
        <h2 id="fecha">Cargando...</h2>
      </div>

      <div id="results"></div>
    </main>
  </div>

  <div class="modal" id="settingsModal">
    <div class="modal__content">
      <h2 style="margin-top: 0;">‚öôÔ∏è Ajustes</h2>
      
      <div class="settings-item">
        <span>Modo Oscuro</span>
        <label class="settings-switch">
          <input type="checkbox" id="darkModeToggle">
          <span class="settings-slider"></span>
        </label>
      </div>

      <div class="settings-item">
        <span>Filtrar Internacional</span>
        <label class="settings-switch">
          <input type="checkbox" id="internationalFilterToggle">
          <span class="settings-slider"></span>
        </label>
      </div>

      <div class="settings-item">
        <span>Agrupar por Eventos</span>
        <label class="settings-switch">
          <input type="checkbox" id="groupChannelsToggle">
          <span class="settings-slider"></span>
        </label>
      </div>

      <div style="margin-bottom: 1.5rem;">
        <span style="display: block; margin-bottom: 8px;">Fuente de Reproductor</span>
        <select id="baseDomainSelect" style="width: 100%; padding: 10px; background: #333; color: white; border: 1px solid #444; border-radius: 8px;">
          <option value="yeahstreams.com/plus/">YeahStreams</option>
          <option value="daddyhd.com/casting/">DaddyHD</option>
          <option value="abbasport.online/footy.php?id=">AbbaSport</option>
          <option value="footballschedule.online/albaplayer/">AlbaPlayer</option>
          <option value="daddylives.top/watch.php?id=">DaddyLives</option>
        </select>
      </div>

      <button class="filter-button" id="closeSettingsBtn" style="background: var(--primary); color: white; justify-content: center;">Guardar y Cerrar</button>
    </div>
  </div>

  <div class="modal" id="favoriteModal">
    <div class="modal__content">
      <h3>‚≠ê Guardar Favorito</h3>
      <input type="text" id="favoriteNameInput" style="width: 100%; padding: 12px; background: #333; border: 1px solid #444; color: white; border-radius: 8px; box-sizing: border-box;">
      <div style="display: flex; gap: 10px; margin-top: 20px;">
        <button class="filter-button" id="saveFavoriteBtn" style="background: var(--primary); color: white; justify-content: center;">Guardar</button>
        <button class="filter-button" id="cancelFavoriteBtn" style="justify-content: center;">Cancelar</button>
      </div>
    </div>
  </div>

  <script>
    // Diccionario de sustituci√≥n de nombres de canales
    const channelNamesMap = {
      "521": "#Vamos",
      "524": "EuroSport 1",
      "525": "EuroSport 2",
      "526": "Movistar Deportes 3",
      "527": "Movistar Deportes 4",
      "528": "Movistar Golf",
      "529": "Teledeporte",
      "530": "GOL PLAY",
      "532": "Telecinco",
      "533": "TVELa1",
      "535": "Cuatro",
      "536": "TVELa2",
      "537": "DAZNF1",
      "539": "LALIGA TV Hypermotion",
      "435": "Movistar Liga de Campeones",
      "436": "Movistar Deportes 4",
      "437": "Movistar Plus+",
      "438": "Movistar Deportes 2",
      "445": "DAZN 1",
      "446": "DAZN 2"
    };

    const state = {
      channels: JSON.parse(localStorage.getItem('channelsCache')) || [],
      currentFilter: 'all',
      searchTerm: '',
      activeEmojiFilters: [],
      favorites: JSON.parse(localStorage.getItem('favorites')) || [],
      customNames: JSON.parse(localStorage.getItem('customNames')) || {},
      baseDomain: localStorage.getItem('baseDomain') || 'daddylives.top/watch.php?id=',
      internationalFilter: localStorage.getItem('internationalFilter') === 'true',
      groupChannels: localStorage.getItem('groupChannels') !== 'false',
      darkMode: localStorage.getItem('darkMode') !== 'false',
      isOnline: navigator.onLine,
      filteredKeywords: ["Cricket", "Russia", "Golf", "PL", "NZ", "BR", "Morocco", "Malaysia", "Arabic"]
    };

    // Funciones de utilidad
    function getDisplayName(channel) {
      // 1. Prioridad: Nombre manual guardado por el usuario
      if (state.customNames[channel.number]) return state.customNames[channel.number];
      // 2. Prioridad: Mapeo autom√°tico por n√∫mero de canal definido arriba
      if (channelNamesMap[channel.number]) return channelNamesMap[channel.number];
      // 3. Fallback: Nombre original del scraper
      return channel.name;
    }

    function adjustTime(time) {
      if (!time || time === 'LIVE') return time;
      const [h, m] = time.split(':').map(Number);
      return `${String((h + 1) % 24).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
    }

    function isChannelLive(channel) {
      if (channel.time === 'LIVE') return true;
      const now = new Date();
      const current = now.getHours() * 60 + now.getMinutes();
      const [h, m] = adjustTime(channel.time).split(':').map(Number);
      const start = h * 60 + m;
      return current >= start - 15 && current <= start + 120;
    }

    // Acciones de UI
    function playChannel(channel) {
      state.currentChannel = channel;
      document.getElementById('playerContainer').classList.add('player-container--active');
      document.getElementById('playerControls').classList.add('player-controls--active');
      document.getElementById('channelInfo').textContent = getDisplayName(channel);
      
      const frame = document.getElementById('videoFrame');
      frame.src = state.baseDomain.includes('php?id=') ? 
        `https://${state.baseDomain}${channel.number}` : 
        `https://${state.baseDomain}stream-${channel.number}.php`;
      
      window.scrollTo({top: 0, behavior: 'smooth'});
    }

    function applyFilter(filter) {
      state.currentFilter = filter;
      document.querySelectorAll('.filter-button').forEach(b => b.classList.remove('filter-button--active'));
      const btn = document.getElementById(`filter${filter.charAt(0).toUpperCase() + filter.slice(1)}`);
      if(btn) btn.classList.add('filter-button--active');
      renderResults();
    }

    function renderResults() {
      const resultsDiv = document.getElementById('results');
      const filtered = state.channels.filter(c => {
        const displayName = getDisplayName(c).toLowerCase();
        if (state.currentFilter === 'favorites' && !state.favorites.includes(c.number)) return false;
        if (state.currentFilter === 'live' && !isChannelLive(c)) return false;
        if (state.searchTerm && !displayName.includes(state.searchTerm.toLowerCase()) && !c.event.toLowerCase().includes(state.searchTerm.toLowerCase())) return false;
        if (state.internationalFilter && state.filteredKeywords.some(k => c.name.includes(k))) return false;
        if (state.activeEmojiFilters.length > 0 && !state.activeEmojiFilters.some(f => c.sport.includes(f) || c.event.includes(f))) return false;
        return true;
      });

      if (state.groupChannels) {
        const groups = {};
        filtered.forEach(c => {
          const key = `${c.event}|${c.time}|${c.sport}`;
          if (!groups[key]) groups[key] = [];
          groups[key].push(c);
        });

        resultsDiv.innerHTML = Object.entries(groups).map(([key, channels]) => {
          const [event, time, sport] = key.split('|');
          return `
            <div class="channel-group">
              <div class="channel-group__header">
                <div class="channel-group__sport">${sport}</div>
                <div class="channel-group__title">
                  <span class="channel-time ${time === 'LIVE' ? 'channel-time--live' : ''}">${adjustTime(time)}</span>
                  ${event}
                </div>
              </div>
              <div class="channel-group__content">
                ${channels.map(c => `
                  <div class="channel-card" onclick='playChannel(${JSON.stringify(c)})'>
                    <div class="channel-number">CH ${c.number}</div>
                    <div class="channel-name">${getDisplayName(c)}</div>
                    <div class="channel-time">${isChannelLive(c) ? 'EN DIRECTO' : 'PR√ìXIMAMENTE'}</div>
                  </div>
                `).join('')}
              </div>
            </div>
          `;
        }).join('');
      }
    }

    async function scrape() {
      try {
        const response = await fetch("https://api.allorigins.win/raw?url=" + encodeURIComponent("https://daddylives.top/match-schedule/"));
        const html = await response.text();
        const doc = new DOMParser().parseFromString(html, "text/html");
        
        const h1Text = doc.querySelector("h1")?.textContent || "";
        document.getElementById('fecha').textContent = h1Text.split('‚Äì')[0] || "Programaci√≥n";

        const found = [];
        doc.querySelectorAll(".match-category").forEach(cat => {
          const sport = cat.querySelector(".category-title")?.textContent.trim();
          cat.querySelectorAll(".match-section").forEach(sec => {
            const time = sec.querySelector(".time")?.textContent.trim();
            const event = sec.querySelector(".match-name")?.textContent.trim();
            sec.querySelectorAll(".link-button").forEach(link => {
              const num = link.textContent.match(/CH-(\d+)/i)?.[1];
              if (num) found.push({ number: num, name: link.textContent.trim(), time, event, sport });
            });
          });
        });

        if (found.length > 0) {
          state.channels = found;
          localStorage.setItem('channelsCache', JSON.stringify(found));
          renderResults();
        }
      } catch (e) { console.error("Error scrape:", e); }
    }

    // EVENTOS DE AJUSTES (LONG PRESS)
    let pressTimer;
    const settingsBtn = document.getElementById('clearEmojiFilters');

    const showSettings = () => {
      document.getElementById('settingsModal').classList.add('modal--active');
    };

    settingsBtn.addEventListener('mousedown', () => pressTimer = setTimeout(showSettings, 800));
    settingsBtn.addEventListener('mouseup', () => clearTimeout(pressTimer));
    settingsBtn.addEventListener('touchstart', () => pressTimer = setTimeout(showSettings, 800));
    settingsBtn.addEventListener('touchend', () => clearTimeout(pressTimer));
    settingsBtn.addEventListener('click', () => {
      state.activeEmojiFilters = [];
      document.querySelectorAll('.emoji-filter-btn').forEach(b => b.classList.remove('emoji-filter-btn--active'));
      renderResults();
    });

    // VINCULACI√ìN DE AJUSTES
    document.getElementById('darkModeToggle').checked = state.darkMode;
    document.getElementById('darkModeToggle').onchange = (e) => {
      state.darkMode = e.target.checked;
      localStorage.setItem('darkMode', state.darkMode);
      document.body.classList.toggle('dark-mode', state.darkMode);
    };

    document.getElementById('internationalFilterToggle').checked = state.internationalFilter;
    document.getElementById('internationalFilterToggle').onchange = (e) => {
      state.internationalFilter = e.target.checked;
      localStorage.setItem('internationalFilter', state.internationalFilter);
      renderResults();
    };

    document.getElementById('groupChannelsToggle').checked = state.groupChannels;
    document.getElementById('groupChannelsToggle').onchange = (e) => {
      state.groupChannels = e.target.checked;
      localStorage.setItem('groupChannels', state.groupChannels);
      renderResults();
    };

    document.getElementById('baseDomainSelect').value = state.baseDomain;
    document.getElementById('baseDomainSelect').onchange = (e) => {
      state.baseDomain = e.target.value;
      localStorage.setItem('baseDomain', state.baseDomain);
    };

    // BOTONES MODAL
    document.getElementById('closeSettingsBtn').onclick = () => document.getElementById('settingsModal').classList.remove('modal--active');
    document.getElementById('closePlayerBtn').onclick = () => {
      document.getElementById('playerContainer').classList.remove('player-container--active');
      document.getElementById('playerControls').classList.remove('player-controls--active');
      document.getElementById('videoFrame').src = '';
    };

    // FILTROS
    document.getElementById('filterAll').onclick = () => applyFilter('all');
    document.getElementById('filterLive').onclick = () => applyFilter('live');
    document.getElementById('filterFavorites').onclick = () => applyFilter('favorites');
    document.getElementById('filterHistory').onclick = () => applyFilter('history');

    document.querySelectorAll('.emoji-filter-btn').forEach(btn => {
      btn.onclick = () => {
        const f = btn.dataset.filter;
        const i = state.activeEmojiFilters.indexOf(f);
        if(i === -1) state.activeEmojiFilters.push(f); else state.activeEmojiFilters.splice(i, 1);
        btn.classList.toggle('emoji-filter-btn--active');
        renderResults();
      };
    });

    document.getElementById('searchInput').oninput = (e) => {
      state.searchTerm = e.target.value;
      renderResults();
    };

    // INICIO
    if(state.darkMode) document.body.classList.add('dark-mode');
    scrape();
    renderResults();
  </script>
</body>
</html>
